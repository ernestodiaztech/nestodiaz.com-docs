name: Deploy Documentation

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: self-hosted  # Changed from ubuntu-latest
    
    steps:
      # Step 1: Checkout code (automatically uses local runner)
      - name: Checkout repository
        uses: actions/checkout@v4
        
      # Step 2: Setup Node.js (if not already installed)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      # Step 3: Install dependencies
      - name: Install dependencies
        run: npm ci
        
      # Step 4: Build the site
      - name: Build Docusaurus site
        run: npm run build
        
      # Step 5: Deploy locally (no SSH needed!)
      - name: Deploy to production
        run: |
          echo "ğŸš€ Starting local deployment at $(date)"
          
          # Copy built files to production location
          # Since we're running on the same machine, we can copy directly
          sudo cp -r build/* /home/nesto/nesto-docs-site/my-website/build/
          
          # Restart the production service
          sudo systemctl restart docusaurus
          
          # Wait and verify service is running
          sleep 5
          if systemctl is-active --quiet docusaurus; then
            echo "âœ… Deployment successful!"
            echo "ğŸ“Š Service status: $(systemctl is-active docusaurus)"
          else
            echo "âŒ Service failed to start"
            exit 1
          fi
          
      # Step 6: Health check
      - name: Verify deployment
        run: |
          echo "ğŸ” Running health checks..."
          
          # Test if the service is responding
          sleep 10
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Health check passed - site is responding"
          else
            echo "âš ï¸  Health check warning - site may not be responding"
          fi
          
          echo "ğŸ‰ Deployment completed at $(date)"
